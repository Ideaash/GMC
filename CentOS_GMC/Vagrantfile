# -*- mode: ruby -*-
# vi: set ft=ruby :

def clean_utf8_string(input)
  input.encode('UTF-16', 'UTF-8', invalid: :replace, replace: '').encode('UTF-8')
end

<<<<<<< HEAD
# Fonction pour obtenir l'adresse IPv4 actuelle sur Windows
def get_ipv4_address
  ipv4_result = `powershell -Command "(Get-NetIPAddress -InterfaceAlias 'Wi-Fi' | Where-Object { $_.AddressFamily -eq 'IPv4' }).IPAddress"`
  cleaned_ipv4_result = clean_utf8_string(ipv4_result).strip
  raise "Impossible de récupérer l'adresse IP." if cleaned_ipv4_result.empty?
  cleaned_ipv4_result
end

=======
>>>>>>> 764baadeda2987ad0a5241800288cb2d7b71e6c1
Vagrant.configure("2") do |config|
  # Configuration principale
  config.vm.box = "centos/7"
  config.vm.synced_folder ".", "/vagrant", disabled: true 

  # Obtenir l'adresse IPv4 actuelle sur Windows
<<<<<<< HEAD
  current_ip = get_ipv4_address

  # Convertir l'adresse IPv4 en un objet IPAddress
  ip_object = current_ip

  # Obtenir les octets de l'adresse IP
  octets = ip_object.split('.').map(&:to_i)

  # Ajouter 1 à la dernière partie de l'adresse IP
  octets[-1] += 1

  # Créer une nouvelle adresse IP en utilisant les octets modifiés
  new_ip = octets.join('.')
  puts "l'adresse ip générée ets : #{new_ip}" 
  config.vm.network "public_network", ip: new_ip

  # Configuration spécifique au fournisseur VirtualBox
  config.vm.provider "virtualbox" do |vb|
    # Paramètres de la machine virtuelle VirtualBox
    # vb.gui = true
    vb.memory = "5000"
    vb.cpus = "2"
  end

=======
  if RbConfig::CONFIG['host_os'] =~ /mswin|mingw|cygwin/
    ipconfig_result = `ipconfig /all`
    cleaned_ipconfig_result = clean_utf8_string(ipconfig_result)
    #puts "ipconfig_result: #{cleaned_ipconfig_result.inspect}"  # Sortie de débogage

    # Utiliser une expression régulière pour extraire l'adresse IPv4
    current_ip_match = cleaned_ipconfig_result.match(/Adresse IPv4[^\d]*(\d+\.\d+\.\d+\.\d+)/)
    current_ip = current_ip_match[1].strip if current_ip_match
  else
    # Sur les systèmes Unix-like, utilisez une autre méthode pour obtenir l'adresse IPv4
    current_ip = `hostname -I | awk '{print $1}'`.strip
  end

  if current_ip.nil? || current_ip.empty?
    raise "Impossible de récupérer l'adresse IP."
  end
  puts "l'adresse ip générée ets : #{current_ip}" 
  # Utiliser l'adresse IP dans la configuration Vagrant
  config.vm.network "public_network", ip: current_ip

  # Configuration spécifique au fournisseur VirtualBox
  config.vm.provider "virtualbox" do |vb|
    # Paramètres de la machine virtuelle VirtualBox
    # vb.gui = true
    vb.memory = "5000"
    vb.cpus = "2"
  end

>>>>>>> 764baadeda2987ad0a5241800288cb2d7b71e6c1
  # Configuration de la provision avec un script shell
  config.vm.provision "shell", inline: <<-SHELL
    sudo yum update
    sudo yum install gedit
  SHELL
end
